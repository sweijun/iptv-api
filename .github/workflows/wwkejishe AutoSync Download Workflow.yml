name: wwkejishe AutoSync Download Workflow
on:
  workflow_dispatch:
  schedule:
    - cron: "10 09,21 * * *" # æ¯å¤©UTCæ—¶é—´18ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥2ç‚¹ï¼‰

jobs:
  sync-iptv-sources:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ç¡®ä¿æœ‰å†™å…¥æƒé™

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºmasteråˆ†æ”¯ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master # æ˜ç¡®æŒ‡å®šmasteråˆ†æ”¯

      # æ­¥éª¤2ï¼šåˆ›å»ºä¸‹è½½ç›®å½•
      - name: Create download directory
        run: mkdir -p Download

      # æ­¥éª¤3ï¼šä¸‹è½½IPTVæºæ–‡ä»¶ï¼ˆæ³¨æ„ï¼šè¿™é‡Œåº”ä½¿ç”¨å®é™…çš„ä¸‹è½½å‘½ä»¤ï¼‰
      - name: Download IPTV sources
        run: |
          curl -o Download/wwkejishe.m3u8 https://raw.githubusercontent.com/swj2323/iptv-api/refs/heads/master/Download/wwkejishe.m3u8

      # æ­¥éª¤4ï¼šæ‰¹é‡æ›¿æ¢æ–‡ä»¶å†…å®¹
      - name: Process files
        run: |
          find Download -type f -name "*.m3u8" -exec sed -i -E 's/^(#EXTINF:-1 group-title="([^"]+)"),([^#]+)/#EXTINF:-1 group-title="\2" tvg-name="\3",\3/' {} +

      # æ­¥éª¤5ï¼šè‡ªåŠ¨æäº¤æ›´æ–°ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰
      - name: Commit changes
        run: |
          git config --global user.name "IPTV Sync Bot"
          git config --global user.email "iptv-sync@noreply.github.com"

          # æ›´å¯é çš„å˜æ›´æ£€æµ‹æ–¹æ³•
          if [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
          else
            # æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ–°å»ºæ–‡ä»¶ï¼‰
            git add -A
            git commit -m "ğŸ“¡ AutoSync IPTV Sources [$(date +'%Y-%m-%d %H:%M UTC')]"
            # å¼ºåˆ¶æ¨é€ç¡®ä¿åŒæ­¥
            git push origin master
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ç¡®ä¿ä»¤ç‰Œæœ‰æ•ˆ

      # æ­¥éª¤6ï¼šä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼‰
      - name: Upload artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: iptv-sources-${{ github.run_id }}
          path: Download/
          retention-days: 3
